<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ecualand Calculator</title>
    <!-- Import Tailwind CSS via CDN for quick styling -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen flex items-center justify-center">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-6 text-center">Ecualand Calculator</h1>
        <div class="max-w-md mx-auto bg-purple-600 p-6 rounded-2xl shadow-lg space-y-4">
            <div>
                <label for="input-value" class="block text-sm mb-1">Valor a enviar</label>
                <input id="input-value" type="number" step="0.01" class="w-full p-3 rounded text-black" value="0" />
            </div>
            <div>
                <label for="input-commission" class="block text-sm mb-1">Comisión (%)</label>
                <input id="input-commission" type="number" step="0.01" class="w-full p-3 rounded text-black" value="0" />
            </div>
            <div>
                <label for="input-extra" class="block text-sm mb-1">Comisión transaccional (extra)</label>
                <input id="input-extra" type="number" step="0.01" class="w-full p-3 rounded text-black" value="2" />
            </div>
            <div class="flex gap-3">
                <button id="btn-calc" class="flex-1 px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-700 text-white font-semibold">Calcular</button>
                <button id="btn-copy" class="flex-1 px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white font-semibold">Copiar</button>
            </div>
            <div id="result" class="text-lg font-medium">Total: -</div>
            <div id="commission-res" class="text-lg font-medium">Comisión: -</div>
            <div id="error" class="text-sm text-red-300"></div>
        </div>
    </div>

    <script>
        // Base URL is relative because the page is served from the same origin as the API
        const API_ENDPOINT = '/api/calculate';
        const USERNAME = 'admin';
        const PASSWORD = 'admin123';

        document.getElementById('btn-calc').addEventListener('click', async () => {
            const value = parseFloat(document.getElementById('input-value').value);
            const commission = parseFloat(document.getElementById('input-commission').value);
            const extra = parseFloat(document.getElementById('input-extra').value);
            const authHeader = 'Basic ' + btoa(USERNAME + ':' + PASSWORD);
            document.getElementById('error').textContent = '';

            // Validate input before sending
            if (isNaN(value) || isNaN(commission) || isNaN(extra)) {
                document.getElementById('error').textContent = 'Por favor ingrese números válidos en todos los campos.';
                return;
            }

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authHeader
                    },
                    body: JSON.stringify({ value, commission, extra })
                });
                if (!response.ok) {
                    throw new Error('La solicitud falló con código ' + response.status);
                }
                const data = await response.json();
                document.getElementById('result').textContent = 'Total: $' + data.finalValue.toFixed(2);
                document.getElementById('commission-res').textContent = 'Comisión: $' + data.commissionAmount.toFixed(2);
            } catch (err) {
                document.getElementById('error').textContent = err.message;
            }
        });

        document.getElementById('btn-copy').addEventListener('click', () => {
            const totalText = document.getElementById('result').textContent.replace('Total: $','');
            const commissionText = document.getElementById('commission-res').textContent.replace('Comisión: $','');
            const tsv = totalText + '\t' + commissionText;
            navigator.clipboard.writeText(tsv);
        });
    </script>
</body>
</html>